name: Update IP List

于:
  schedule:
    - cron: '*/30 * * * *'  # 每隔三十分钟运行一次
  workflow_dispatch:  # 手动触发
  # push: # 允许提交触发

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # 获取完整的历史记录
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        pip install beautifulsoup4
        
    - name: List files before script
      run: |
        echo "当前目录文件列表:"
        ls -la
        echo "---"
        
    - name: Run script
      run: |
        python collect_ips.py
        echo "脚本执行完成，检查ip.txt:"
        if [ -f "ip.txt" ]; then
          echo "ip.txt存在，内容前10行:"
          head -10 ip.txt
          echo "文件行数:"
          wc -l ip.txt
        else
          echo "ip.txt不存在!"
        fi
        
    - name: Show git status
      run: |
        echo "Git状态:"
        git status
        echo "---"
        echo "Git diff:"
        git diff --name-only
        
    - name: Commit and push changes
      run: |
        git config --global user.email "tonyya92@outlook.com"
        git config --global user.name "ya950"
        git config --global pull.rebase false
        
        # 拉取最新更改，避免冲突
        git pull origin main
        
        if [ -n "$(git status --porcelain ip.txt)" ]; then
          echo "检测到ip.txt有变化"
          git add ip.txt
          git commit -m "Automatic update: $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
          echo "已提交并推送更改"
        else
          echo "ip.txt没有变化，跳过提交"
        fi
